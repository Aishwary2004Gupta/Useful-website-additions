<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pixel Trail (Three.js)</title>
  <style>
    body {
      margin: 0;
      background: black;
      overflow: hidden;
    }
    canvas {
      display: block;
      position: absolute;
      width: 100%;
      height: 100%;
    }
    svg {
      position: absolute;
      width: 0;
      height: 0;
    }
  </style>
</head>
<body>
  <!-- Gooey filter -->
  <svg>
    <defs>
      <filter id="goo-filter">
        <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur"/>
        <feColorMatrix in="blur" type="matrix"
          values="1 0 0 0 0  
                  0 1 0 0 0  
                  0 0 1 0 0  
                  0 0 0 18 -7" result="goo"/>
        <feComposite in="SourceGraphic" in2="goo" operator="atop"/>
      </filter>
    </defs>
  </svg>

  <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.min.js"></script>
  <script id="vertexShader" type="x-shader/x-vertex">
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  </script>
  <script id="fragmentShader" type="x-shader/x-fragment">
    uniform vec2 resolution;
    uniform sampler2D mouseTrail;
    uniform float gridSize;
    uniform vec3 pixelColor;
    varying vec2 vUv;

    vec2 coverUv(vec2 uv) {
      vec2 s = resolution.xy / max(resolution.x, resolution.y);
      return (uv - 0.5) * s + 0.5;
    }

    void main() {
      vec2 uv = coverUv(vUv);
      vec2 gridUvCenter = (floor(uv * gridSize) + 0.5) / gridSize;
      float trail = texture2D(mouseTrail, gridUvCenter).r;
      gl_FragColor = vec4(pixelColor, trail);
    }
  </script>

  <script>
    const gridSize = 50;
    const trailSize = 0.05;
    const maxAge = 200;
    const color = new THREE.Color("#ffffff");

    const renderer = new THREE.WebGLRenderer({ antialias: false });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.domElement.style.filter = "url(#goo-filter)";
    document.body.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    const camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);

    // Create render target for mouse trail
    const trailSizePx = 512;
    let trailTarget = new THREE.WebGLRenderTarget(trailSizePx, trailSizePx);

    // Material with shaders
    const material = new THREE.ShaderMaterial({
      uniforms: {
        resolution: { value: new THREE.Vector2(window.innerWidth, window.innerHeight) },
        mouseTrail: { value: trailTarget.texture },
        gridSize: { value: gridSize },
        pixelColor: { value: color }
      },
      vertexShader: document.getElementById("vertexShader").textContent,
      fragmentShader: document.getElementById("fragmentShader").textContent,
      transparent: true
    });

    const plane = new THREE.Mesh(new THREE.PlaneGeometry(2, 2), material);
    scene.add(plane);

    // Mouse trail canvas
    const trailCanvas = document.createElement("canvas");
    trailCanvas.width = trailCanvas.height = trailSizePx;
    const ctx = trailCanvas.getContext("2d");
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, trailSizePx, trailSizePx);

    const trailTexture = new THREE.CanvasTexture(trailCanvas);
    material.uniforms.mouseTrail.value = trailTexture;

    const mouse = { x: 0, y: 0 };
    document.addEventListener("mousemove", (e) => {
      mouse.x = e.clientX / window.innerWidth;
      mouse.y = 1.0 - e.clientY / window.innerHeight;
    });

    function drawTrail() {
      ctx.fillStyle = "rgba(0,0,0,0.05)";
      ctx.fillRect(0, 0, trailSizePx, trailSizePx);

      ctx.beginPath();
      ctx.arc(mouse.x * trailSizePx, mouse.y * trailSizePx, trailSizePx * trailSize, 0, Math.PI * 2);
      ctx.fillStyle = "rgba(255,255,255,1)";
      ctx.fill();

      trailTexture.needsUpdate = true;
    }

    function animate() {
      requestAnimationFrame(animate);
      drawTrail();
      renderer.render(scene, camera);
    }

    animate();

    window.addEventListener("resize", () => {
      renderer.setSize(window.innerWidth, window.innerHeight);
      material.uniforms.resolution.value.set(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
