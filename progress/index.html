<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Depixelation Effect</title>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  font-family: system-ui, sans-serif;
}

.viewer {
  position: relative;
  background: #111;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 20px 40px rgba(0,0,0,.6);
}

canvas {
  display: block;
}

/* -------- TOP IMAGE INPUT BAR -------- */
.top-bar {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 6px;
  background: rgba(20,20,20,.85);
  padding: 8px;
  border-radius: 10px;
  backdrop-filter: blur(8px);
  z-index: 10;
}

.top-bar input[type="text"] {
  width: 220px;
  background: #111;
  border: 1px solid #333;
  color: #fff;
  border-radius: 6px;
  padding: 6px;
  font-size: 12px;
}

.top-bar input[type="file"] {
  display: none;
}

.top-bar label,
.top-bar button {
  background: #2b7cff;
  border: none;
  color: #fff;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  white-space: nowrap;
}

.top-bar button.secondary {
  background: #333;
}

/* -------- BOTTOM CONTROLS -------- */
.controls {
  position: absolute;
  bottom: 14px;
  right: 14px;
  display: flex;
  gap: 8px;
}

.controls button {
  padding: 10px 16px;
  border-radius: 10px;
  background: rgba(30,30,30,.85);
  color: #fff;
  border: 1px solid #333;
  cursor: pointer;
  font-size: 13px;
  backdrop-filter: blur(6px);
}
</style>

<script async src="https://unpkg.com/es-module-shims@1.10.0/dist/es-module-shims.js"></script>
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
  }
}
</script>
</head>

<body>
<div class="viewer" id="viewer">

  <!-- TOP BAR -->
  <div class="top-bar">
    <input id="imgUrl" type="text" placeholder="Paste image URLâ€¦" />
    <button id="loadUrl">Load</button>
    <label for="fileInput">Upload</label>
    <input id="fileInput" type="file" accept="image/*" />
  </div>

  <!-- BOTTOM CONTROLS -->
  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="reverseBtn">Reverse</button>
  </div>
</div>

<script type="module">
import * as THREE from "three";
import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";
import { RenderPass } from "three/addons/postprocessing/RenderPass.js";
import { ShaderPass } from "three/addons/postprocessing/ShaderPass.js";

const container = document.getElementById("viewer");
const startBtn = document.getElementById("startBtn");
const reverseBtn = document.getElementById("reverseBtn");
const imgUrl = document.getElementById("imgUrl");
const loadUrl = document.getElementById("loadUrl");
const fileInput = document.getElementById("fileInput");

/* -------- SHADER -------- */
const DepixelShader = {
  uniforms: {
    tDiffuse: { value: null },
    progress: { value: 0 },
    resolution: { value: new THREE.Vector2() }
  },
  vertexShader: `
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
    }
  `,
  fragmentShader: `
    precision highp float;
    uniform sampler2D tDiffuse;
    uniform float progress;
    uniform vec2 resolution;
    varying vec2 vUv;

    void main() {
      float size = mix(48.0, 1.0, progress);
      vec2 pix = size / resolution;
      vec2 uv = pix * floor(vUv / pix);
      gl_FragColor = texture2D(tDiffuse, uv);
    }
  `
};

/* -------- THREE -------- */
const renderer = new THREE.WebGLRenderer({ antialias: true });
container.appendChild(renderer.domElement);

const scene = new THREE.Scene();
const camera = new THREE.OrthographicCamera();
camera.position.z = 10;

let plane, texture;

const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
const shaderPass = new ShaderPass(DepixelShader);
composer.addPass(shaderPass);

function resize(img) {
  const padding = 40;
  const maxW = innerWidth - padding;
  const maxH = innerHeight - padding;
  const s = Math.min(maxW / img.width, maxH / img.height, 1);

  const w = img.width * s;
  const h = img.height * s;

  container.style.width = w + "px";
  container.style.height = h + "px";

  renderer.setSize(w, h);
  composer.setSize(w, h);
  shaderPass.uniforms.resolution.value.set(w, h);

  camera.left = -w / 2;
  camera.right = w / 2;
  camera.top = h / 2;
  camera.bottom = -h / 2;
  camera.updateProjectionMatrix();

  plane.scale.set(w, h, 1);
}

function loadImage(src) {
  new THREE.TextureLoader().load(src, tex => {
    texture?.dispose();
    texture = tex;
    texture.colorSpace = THREE.SRGBColorSpace;

    if (!plane) {
      plane = new THREE.Mesh(
        new THREE.PlaneGeometry(1, 1),
        new THREE.MeshBasicMaterial({ map: texture })
      );
      scene.add(plane);
    } else {
      plane.material.map = texture;
      plane.material.needsUpdate = true;
    }

    resize(texture.image);
    shaderPass.uniforms.progress.value = 0;
  });
}

/* -------- IMAGE INPUT -------- */
loadUrl.onclick = () => imgUrl.value && loadImage(imgUrl.value);
fileInput.onchange = e =>
  loadImage(URL.createObjectURL(e.target.files[0]));

/* -------- ANIMATION -------- */
let progress = 0;
let direction = 0;
const speed = 0.003;

startBtn.onclick = () => { progress = 0; direction = 1; };
reverseBtn.onclick = () => { progress = 1; direction = -1; };

function animate() {
  requestAnimationFrame(animate);

  if (direction !== 0) {
    progress += speed * direction;
    progress = Math.max(0, Math.min(1, progress));
    shaderPass.uniforms.progress.value = progress;
    if (progress === 0 || progress === 1) direction = 0;
  }

  composer.render();
}
animate();

window.addEventListener("resize", () => {
  if (texture?.image) resize(texture.image);
});

/* -------- DEFAULT IMAGE -------- */
loadImage(
  "https://cdn.maximeheckel.com/images/backgrounds/gril-with-pearl-earing.jpg"
);
</script>
</body>
</html>
