<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Depixelation Effect</title>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  font-family: system-ui, sans-serif;
}

.viewer {
  position: relative;
  background: #111;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 20px 40px rgba(0,0,0,.6);
}

/* ---------- CONTROL PANEL ---------- */
.panel {
  position: absolute;
  top: 14px;
  right: 14px;
  width: 260px;
  background: rgba(20,20,20,.85);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 12px;
  color: #ddd;
  font-size: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.panel h4 {
  margin: 0;
  font-weight: 500;
  color: #fff;
  font-size: 13px;
}

.control {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.control label {
  opacity: .75;
}

input[type="range"] {
  width: 100%;
}

input[type="text"] {
  background: #111;
  border: 1px solid #333;
  color: #fff;
  border-radius: 6px;
  padding: 6px;
  font-size: 12px;
}

button {
  background: #2b7cff;
  border: none;
  border-radius: 6px;
  color: #fff;
  padding: 6px;
  font-size: 12px;
  cursor: pointer;
}

button.secondary {
  background: #333;
}

.panel-toggle {
  position: absolute;
  top: 14px;
  left: 14px;
  background: #111;
  border-radius: 50%;
  width: 34px;
  height: 34px;
  display: grid;
  place-items: center;
  cursor: pointer;
  color: #fff;
}
</style>

<script async src="https://unpkg.com/es-module-shims@1.10.0/dist/es-module-shims.js"></script>
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
  }
}
</script>
</head>

<body>
<div class="viewer" id="viewer">

  <div class="panel-toggle" id="toggle">☰</div>

  <div class="panel" id="panel">
    <h4>Controls</h4>

    <div class="control">
      <label>Progress</label>
      <input id="progress" type="range" min="0" max="1" step="0.001" value="0" />
    </div>

    <div class="control">
      <label>Reveal Speed</label>
      <input id="speed" type="range" min="0.5" max="10" step="0.1" value="4" />
    </div>

    <div class="control">
      <label>Image URL</label>
      <input id="imgUrl" type="text" placeholder="Paste image URL…" />
      <button id="loadUrl">Load URL</button>
    </div>

    <div class="control">
      <label>Upload Image</label>
      <input id="fileInput" type="file" accept="image/*" />
    </div>

    <button class="secondary" id="reset">Reset Progress</button>
  </div>

</div>

<script type="module">
import * as THREE from "three";
import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";
import { RenderPass } from "three/addons/postprocessing/RenderPass.js";
import { ShaderPass } from "three/addons/postprocessing/ShaderPass.js";

const container = document.getElementById("viewer");

/* ---------- SHADER ---------- */
const DepixelShader = {
  uniforms: {
    tDiffuse: { value: null },
    progress: { value: 0 },
    resolution: { value: new THREE.Vector2() },
    time: { value: 0 }
  },
  vertexShader: `
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
    }
  `,
  fragmentShader: `
    precision highp float;
    uniform sampler2D tDiffuse;
    uniform float progress;
    uniform vec2 resolution;
    varying vec2 vUv;

    void main() {
      float size = mix(32.0, 1.0, progress);
      vec2 pix = size / resolution;
      vec2 uv = pix * floor(vUv / pix);
      gl_FragColor = texture2D(tDiffuse, uv);
    }
  `
};

/* ---------- THREE ---------- */
const renderer = new THREE.WebGLRenderer({ antialias: true });
container.appendChild(renderer.domElement);

const scene = new THREE.Scene();
const camera = new THREE.OrthographicCamera();
camera.position.z = 10;

let plane, texture;

const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
const shaderPass = new ShaderPass(DepixelShader);
composer.addPass(shaderPass);

function resize(img) {
  const maxW = innerWidth - 40;
  const maxH = innerHeight - 40;
  const s = Math.min(maxW / img.width, maxH / img.height, 1);
  const w = img.width * s;
  const h = img.height * s;

  container.style.width = w + "px";
  container.style.height = h + "px";

  renderer.setSize(w, h);
  composer.setSize(w, h);
  shaderPass.uniforms.resolution.value.set(w, h);

  camera.left = -w / 2;
  camera.right = w / 2;
  camera.top = h / 2;
  camera.bottom = -h / 2;
  camera.updateProjectionMatrix();

  plane.scale.set(w, h, 1);
}

function loadImage(src) {
  new THREE.TextureLoader().load(src, tex => {
    texture?.dispose();
    texture = tex;
    texture.colorSpace = THREE.SRGBColorSpace;

    if (!plane) {
      plane = new THREE.Mesh(
        new THREE.PlaneGeometry(1, 1),
        new THREE.MeshBasicMaterial({ map: texture })
      );
      scene.add(plane);
    } else {
      plane.material.map = texture;
    }
    resize(texture.image);
  });
}

loadImage("https://cdn.maximeheckel.com/images/backgrounds/gril-with-pearl-earing.jpg");

/* ---------- UI ---------- */
const panel = document.getElementById("panel");
toggle.onclick = () => panel.style.display =
  panel.style.display === "none" ? "flex" : "none";

loadUrl.onclick = () => imgUrl.value && loadImage(imgUrl.value);
fileInput.onchange = e =>
  loadImage(URL.createObjectURL(e.target.files[0]));
reset.onclick = () => progress.value = 0;

/* ---------- ANIMATION ---------- */
let smooth = 0;
function animate(t) {
  requestAnimationFrame(animate);
  const speed = +document.getElementById("speed").value;
  smooth += (progress.value - smooth) * 0.02 * speed;
  shaderPass.uniforms.progress.value = smooth;
  composer.render();
}
animate(0);
</script>
</body>
</html>
