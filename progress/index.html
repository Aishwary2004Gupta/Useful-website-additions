<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Depixelation Effect</title>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  font-family: system-ui, sans-serif;
}

.viewer {
  position: relative;
  background: #111;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 20px 40px rgba(0,0,0,.6);
}

canvas {
  display: block;
}
</style>

<script async src="https://unpkg.com/es-module-shims@1.10.0/dist/es-module-shims.js"></script>
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
  }
}
</script>
</head>

<body>
<div class="viewer" id="viewer"></div>

<script type="module">
import * as THREE from "three";
import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";
import { RenderPass } from "three/addons/postprocessing/RenderPass.js";
import { ShaderPass } from "three/addons/postprocessing/ShaderPass.js";

const container = document.getElementById("viewer");

/* ---------- SHADER ---------- */
const DepixelShader = {
  uniforms: {
    tDiffuse: { value: null },
    progress: { value: 0 },
    resolution: { value: new THREE.Vector2() },
    time: { value: 0 }
  },
  vertexShader: `
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
    }
  `,
  fragmentShader: `
    precision highp float;
    uniform sampler2D tDiffuse;
    uniform float progress;
    uniform vec2 resolution;
    varying vec2 vUv;

    void main() {
      float size = mix(48.0, 1.0, progress);
      vec2 pix = size / resolution;
      vec2 uv = pix * floor(vUv / pix);
      gl_FragColor = texture2D(tDiffuse, uv);
    }
  `
};

/* ---------- THREE SETUP ---------- */
const renderer = new THREE.WebGLRenderer({ antialias: true });
container.appendChild(renderer.domElement);

const scene = new THREE.Scene();
const camera = new THREE.OrthographicCamera();
camera.position.z = 10;

let plane, texture;

const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
const shaderPass = new ShaderPass(DepixelShader);
composer.addPass(shaderPass);

function resize(img) {
  const padding = 40;
  const maxW = innerWidth - padding;
  const maxH = innerHeight - padding;
  const s = Math.min(maxW / img.width, maxH / img.height, 1);

  const w = img.width * s;
  const h = img.height * s;

  container.style.width = w + "px";
  container.style.height = h + "px";

  renderer.setSize(w, h);
  composer.setSize(w, h);
  shaderPass.uniforms.resolution.value.set(w, h);

  camera.left = -w / 2;
  camera.right = w / 2;
  camera.top = h / 2;
  camera.bottom = -h / 2;
  camera.updateProjectionMatrix();

  plane.scale.set(w, h, 1);
}

function loadImage(src) {
  new THREE.TextureLoader().load(src, tex => {
    texture?.dispose();
    texture = tex;
    texture.colorSpace = THREE.SRGBColorSpace;

    if (!plane) {
      plane = new THREE.Mesh(
        new THREE.PlaneGeometry(1, 1),
        new THREE.MeshBasicMaterial({ map: texture })
      );
      scene.add(plane);
    } else {
      plane.material.map = texture;
      plane.material.needsUpdate = true;
    }

    resize(texture.image);
  });
}

/* ---------- IMAGE ---------- */
loadImage(
  "https://pbs.twimg.com/profile_images/1985967049378820096/6KOnyC-C_400x400.jpg"
);

/* ---------- ANIMATION ---------- */
let progress = 0;
function animate(t) {
  requestAnimationFrame(animate);
  progress = Math.min(progress + 0.0025, 1.0);
  shaderPass.uniforms.progress.value = progress;
  composer.render();
}
animate(0);

window.addEventListener("resize", () => {
  if (texture?.image) resize(texture.image);
});
</script>
</body>
</html>
